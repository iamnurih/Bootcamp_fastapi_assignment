
 Aerich로 DB 마이그레이션 관리하기

#### 왜 `Aerich`가 필요한가?

지금까지 우리는 `main.py`의 `await Tortoise.generate_schemas()` 코드를 사용해서 서버가 시작될 때마다 테이블을 자동으로 만들었습니다. 이건 개발 초기에는 아주 편리하지만, 실제 서비스를 운영할 때는 **매우 위험한 방법**입니다.

만약 `User` 모델에서 `email` 필드를 실수로 지우고 서버를 재시작하면, `generate_schemas`는 "어? 설계도에 `email`이 없네?" 하고 **데이터베이스에서 `email` 열을 통째로 날려버릴 수 있습니다!** 모든 사용자의 이메일 정보가 사라지는 끔찍한 사고가 발생하죠.

**데이터베이스 마이그레이션(Migration)**은 이처럼 데이터베이스의 구조(스키마)를 **안전하고 체계적으로 변경**하기 위한 과정입니다. **`Aerich`**는 Tortoise ORM을 위한 마이그레이션 전문 도구입니다.

> **비유**: `generate_schemas`는 매번 건물을 새로 부수고 짓는 **'재개발'**이고, `Aerich`는 기존 건물의 구조를 안전하게 변경하는 **'리모델링'**과 같습니다.

### Aerich 사용법 (Step-by-Step)

#### 1 단계: Aerich 설치

먼저, `aerich`를 개발용 라이브러리로 설치합니다.

Bash

```
poetry add aerich --group dev
```

#### 2단계: `main.py` 코드 수정

이제 `Aerich`가 데이터베이스 구조 변경을 전담할 것이므로, `main.py`에서 위험한 `generate_schemas` 코드를 제거(주석 처리)해야 합니다.

Python

```
# app/main.py

# ... (다른 import 구문들) ...

@asynccontextmanager
async def lifespan(app: FastAPI):
    print("애플리케이션 시작...")
    await Tortoise.init(
        db_url=settings.DATABASE_URL,
        modules={"models": ["app.models"]}
    )
    # 아래 라인을 주석 처리하거나 삭제합니다.
    # await Tortoise.generate_schemas() 
    print("데이터베이스 초기화 완료.")
    
    yield
    
    print("애플리케이션 종료...")
    await Tortoise.close_connections()
    print("데이터베이스 연결 종료 완료.")

# ... (나머지 코드는 동일) ...
```


## aerich.ini 파일 생성 

프로젝트의 루트 폴더(`pyproject.toml`과 같은 위치)에 **`aerich.ini`** 라는 이름의 새 파일을 만들고, 아래 내용을 붙여넣어 주세요.

Ini, TOML

```
# aerich.ini

[aerich]
tortoise_orm = tortoise_config.TORTOISE_ORM
location = ./migrations
```

---

### `tortoise_config.py` 파일 만들기

`aerich.ini`가 참조할 설정 파일을 만들어야 합니다. `app` 폴더 안에 **`tortoise_config.py`** 라는 새 파일을 만들고 아래 내용을 붙여넣으세요.

Python

```
# app/tortoise_config.py

from app.config import settings

TORTOISE_ORM = {
    "connections": {"default": settings.DATABASE_URL},
    "apps": {
        "models": {
            "models": ["app.models", "aerich.models"],
            "default_connection": "default",
        },
    },
}
```

이 파일은 `main.py`에 있던 `Tortoise.init()` 설정 내용을 `aerich`가 알아볼 수 있는 형태로 따로 빼낸 것입니다.

---

###  `main.py` 코드 정리

이제 DB 설정이 `tortoise_config.py`로 옮겨졌으니, `main.py`를 더 깔끔하게 만들 수 있습니다.

`app/main.py` 파일을 아래와 같이 수정해주세요.

Python

```
# app/main.py

from contextlib import asynccontextmanager
from fastapi import FastAPI
from tortoise import Tortoise
from .tortoise_config import TORTOISE_ORM # tortoise_config 에서 설정을 가져옵니다.

@asynccontextmanager
async def lifespan(app: FastAPI):
    print("애플리케이션 시작...")
    # Tortoise.init에 직접 설정값을 넣는 대신, TORTOISE_ORM 변수를 사용합니다.
    await Tortoise.init(config=TORTOISE_ORM)
    print("데이터베이스 초기화 완료.")
    
    yield

    print("애플리케이션 종료...")
    await Tortoise.close_connections()
    print("데이터베이스 연결 종료 완료.")

app = FastAPI(lifespan=lifespan)

@app.get("/")
async def read_root():
    return {"message": "Hello World"}
```

---

### 4단계: `aerich init-db` 다시 실행하기

이제 모든 설정이 준비되었습니다. 터미널에서 다시 `aerich init-db` 명령어를 실행해 보세요.

Bash

```
poetry run aerich init-db
```

이번에는 `aerich.ini` 파일을 통해 `tortoise_config.py`의 설정값을 정확히 찾아가므로, 성공적으로 실행되고 `migrations` 폴더가 생성될 겁니다.


## `aerich init-db` 명령어의 두 가지 역할

`aerich init-db` 명령어는 상황에 따라 두 가지 다른 행동을 합니다.

### **상황 1: 설정 파일이 없을 때 (제가 처음에 설명한 이상적인 경우)**

- `aerich`가 자동으로 설정을 찾을 수 있다면, `aerich init-db` 명령어는 **`aerich.ini` 설정 파일**과 **`migrations` 폴더**를 **자동으로 생성**해 줍니다.
    

### **상황 2: 에러가 나서 우리가 직접 설정 파일을 만들었을 때 (바로 지금 우리 상황)**

- `aerich`가 설정을 못 찾아서 에러가 났고, 그래서 우리가 `aerich.ini`와 `tortoise_config.py`를 **직접 손으로 만들었습니다.**
    
- 이렇게 설정 파일이 **이미 존재하는 상태**에서 `aerich init-db`를 실행하면, 이 명령어의 역할이 바뀝니다.
    
    - 1. `aerich.ini` 파일을 **읽어서** 데이터베이스 접속 정보를 확인합니다.
            
    - 2. 데이터베이스에 **접속**합니다.
            
    - 3. 앞으로 마이그레이션 버전을 관리하는 데 필요한 **`aerich`라는 테이블을 DB 안에 생성**합니다.
            
    - 4. `migrations` 폴더를 생성합니다.
            

---

**결론적으로, 제가 이전 단계에서 "파일을 직접 만들라"고 안내했기 때문에, 이제 `aerich init-db`는 파일을 새로 만드는 대신, 우리가 만든 설정 파일을 읽어서 DB에 접속하고 필요한 테이블을 만드는 역할을 하게 된 것입니다.**